apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: supermanus-ingress
  namespace: supermanus
  labels:
    app: supermanus-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/websocket-services: "mcp-server"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$request_uri"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - supermanus.local
    - api.supermanus.local
    - flower.supermanus.local
    - monitoring.supermanus.local
    secretName: supermanus-tls
  rules:
  # Main API Gateway
  - host: api.supermanus.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mcp-server
            port:
              number: 8000
      - path: /ws
        pathType: Prefix
        backend:
          service:
            name: mcp-server
            port:
              number: 8001
  
  # Service-specific endpoints
  - host: supermanus.local
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: mcp-server
            port:
              number: 8000
      - path: /voice
        pathType: Prefix
        backend:
          service:
            name: voice-pipeline
            port:
              number: 8000
      - path: /image
        pathType: Prefix
        backend:
          service:
            name: image-generator
            port:
              number: 8000
      - path: /code
        pathType: Prefix
        backend:
          service:
            name: code-generator
            port:
              number: 8000
      - path: /search
        pathType: Prefix
        backend:
          service:
            name: search-service
            port:
              number: 8000
  
  # Monitoring endpoints
  - host: flower.supermanus.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: celery-flower
            port:
              number: 5555
  
  - host: monitoring.supermanus.local
    http:
      paths:
      - path: /prometheus
        pathType: Prefix
        backend:
          service:
            name: prometheus
            port:
              number: 9090
      - path: /grafana
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000

---
apiVersion: v1
kind: Secret
metadata:
  name: supermanus-tls
  namespace: supermanus
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCi4uLgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0t  # placeholder cert
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCi4uLgotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0t  # placeholder key